var cropbox=function(t,e){var e=e||$(t.imageBox),i={state:{},ratio:1,options:t,imageBox:e,thumbBox:e.find(t.thumbBox),spinner:e.find(t.spinner),image:new Image,getAvatar:function(){var i=this.thumbBox.width(),n=this.thumbBox.height(),a=document.createElement("canvas"),o=e.css("background-position").split(" "),s=e.css("background-size").split(" "),r=parseInt(o[0])-e.width()/2+i/2,g=parseInt(o[1])-e.height()/2+n/2,u=parseInt(s[0]);dh=parseInt(s[1]),sh=parseInt(this.image.height),sw=parseInt(this.image.width),a.width=i,a.height=n;var c=a.getContext("2d");t.imgBackground&&(c.fillStyle=t.imgBackground,c.fillRect(0,0,i,n)),c.drawImage(this.image,0,0,sw,sh,r,g,u,dh);var m=a.toDataURL("image/jpeg");return m},getBlobFile:function(){for(var t=this.getAvatar(),e=t.replace("data:image/jpeg;base64,",""),i=atob(e),n=[],a=0;a<i.length;a++)n.push(i.charCodeAt(a));return new Blob([new Uint8Array(n)],{type:"image/jpeg"})},zoomIn:function(){this.ratio*=1.1,n()},zoomOut:function(){this.ratio*=.9,n()}},n=function(){var t=parseInt(i.image.width)*i.ratio,n=parseInt(i.image.height)*i.ratio,a=(e.width()-t)/2,o=(e.height()-n)/2;e.css({"background-image":"url("+i.image.src+")","background-size":t+"px "+n+"px","background-position":a+"px "+o+"px","background-repeat":"no-repeat"})},a=function(t){t.stopImmediatePropagation(),i.state.dragable=!0,i.state.mouseX=t.clientX,i.state.mouseY=t.clientY},o=function(t){if(t.stopImmediatePropagation(),i.state.dragable){var n=t.clientX-i.state.mouseX,a=t.clientY-i.state.mouseY,o=e.css("background-position").split(" "),s=n+parseInt(o[0]),r=a+parseInt(o[1]);e.css("background-position",s+"px "+r+"px"),i.state.mouseX=t.clientX,i.state.mouseY=t.clientY}},s=function(t){t.stopImmediatePropagation(),i.state.dragable=!1},r=function(t){t.originalEvent.wheelDelta>0||t.originalEvent.detail<0?i.ratio*=1.1:i.ratio*=.9,n()};return i.spinner.show(),i.image.onload=function(){i.spinner.hide(),n(),e.bind("mousedown",a),e.bind("mousemove",o),$(window).bind("mouseup",s),e.bind("mousewheel DOMMouseScroll",r)},i.image.src=t.imgSrc,e.on("remove",function(){$(window).unbind("mouseup",s)}),i};jQuery.fn.cropbox=function(t){return new cropbox(t,this)};